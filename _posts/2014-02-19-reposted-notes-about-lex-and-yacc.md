---
layout: post
title: "Reposted notes about lex and yacc"
description: ""
category: notes
tags: lex yacc compiler vim
---
{% include JB/setup %}

### 又做了件无聊的事

最近看到一本书，讲OpenMP的编译和实现的。里边谈到了lex和yacc的使用。
由于之前这部分内容没有接触过，于是决定先学习下这两个神奇的工具。
又，经由王大神的推荐，看到了[这个系列的中文版教程](http://blog.csdn.net/liwei_cmg/article/details/1530492)
着实是我等英文捉鸡分子的福音，而后由于本校落后的网络条件，我决定把这部分博文copy到本地慢慢研读。
而后我将这部分文章转成vimwiki收录到我的仓库中了，这是一件痛苦的工作。
我之所以这么做主要是出于以下几点的考虑:

* 这些文章写的很是精髓，我希望将其收藏在个人仓库中
* 原作的排版不太符合我的阅读习惯，我希望不论是文本还是html，都能有:
    * 不一样大小的字体（方便理解层次关系）
    * 不一样字体颜色的标题（vim中表现为高亮）
    * 清晰的codeblock，规范的缩进，最好能有代码高亮
* 这样做之后在vim下阅读真的很舒服~，因为:
    * 我有vimwiki的tag生成法则，对于这些长文，提纲挈领是有必要的
    * 我有vimwiki的codeblock自动高亮插件，就是我写的vim-regionsyntax，虽然还是有很多bug，但是我觉得是存在相当的作用的。

其实可能对于高智商的同志来说这是个入不敷出的工作，但无奈我觉得我自身有一定的阅读障碍，面对长文一直有心无力。
我发现tagbar或者是高亮这一类的东西能够提升我不少的学习效率。再一个，我可能有轻微的强迫症，希望东西尽可能的整洁有序。

放上我[整理后的版本](https://dl.dropboxusercontent.com/u/22574484/compilers.html)吧，不敢说排版比原作好，但至少更符合我的阅读习惯，不敢说排版比原作好，但至少更符合我的阅读习惯。
其实还是存在很多问题，比如：

* 我把最后一章讲windows下方案的给删了，个人不感兴趣
* 由于下面提到的这个bug，在前面几篇文章的几处代码中的中文注释都有修改或删除。
* 由于pygments貌似没有lex和yacc的高亮规则（vim是有的），基本上采取了c。某些地方不够准确

### 奇怪的bug

我在[这里](/tweak/2013/08/28/use-pygments-with-vimwiki/) 记录了通过pygments生成vimwiki-html的代码块高亮的一种方法。
在这次的蛋疼过程中，我发现这个版本有很严重的bug。如果代码块中出现非ascii的unicode，会有提示说译码错误。
这是个很神奇的错误，因为这个函数主要的工作是这样两步:

* 调用pygments产生翻译之后的pre tag
* 通过vim的system()函数读取pygments命令产生的output

如果分别执行这两步，结果非常和谐，pygments默认的编码就是utf-8，而system()同样可以读取unicode。
但是如果并成一部就会出现编码问题。这个让人费解，也许得涉及到vim中system()函数的实现机制。

我并没有尝试过vimproc中相应的函数是否也存在同样的问题，我猜测应该是一个结果。我最后还是通过一个很丑陋的手段修复了这个bug。
就是将pygments的输出写到临时文件中，然后读取该文件。

### 收获

这么做大概浪费了我将近两个小时的时间，包括修复那个bug在内，要是算上写这篇玩意和其它乱七八糟的破事，怎么也得将近三小时。
但是我个人觉得还是划得来的，完事之后的学习效率可以提升不少。
另外我学到了一个用vim记笔记的小窍门。

如果说用vim记笔记有什么弱势的话，就是不能画图。有的时候一图胜千言。
如果插入dot那种画流程图的语言，然后在html上插入图片的话，

1. 很麻烦
2. 文本模式下就不能浏览了

而如果用drawit插件那样画ascii的结构图，则在转成html的时候会有不小的毛病，换行啊，空格啥的。
我曾经还为了排这个把css样式中的字体设置成等宽，为了让box看上去更和谐。
我认为一种不俗的解决方案就是

依旧使用drawit画出ascii结构图，然后用codeblock包住，pygments的lexer就选用text即可。
这样，文本模式下的造型将和html下保持一致（字体还是得选等宽的）。
好简单的方法，我之前居然没想到，诶......

最后上个vim下阅读的效果图吧，因为施工的关系，目前才看到第五部分。

![vim-reader](/assets/images/article/vim-reader.png)
